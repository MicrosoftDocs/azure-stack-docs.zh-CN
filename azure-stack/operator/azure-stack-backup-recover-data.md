---
title: 在 Azure Stack 中从灾难性数据丢失中恢复 |Microsoft Docs
description: 了解如何在发生灾难性数据丢失后恢复和还原 Azure Stack 中的基础结构数据。
services: azure-stack
documentationcenter: ''
author: justinha
manager: femila
editor: ''
ms.assetid: 2ECE8580-0BDE-4D4A-9120-1F6771F2E815
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/12/2019
ms.author: justinha
ms.reviewer: hectorl
ms.lastreviewed: 11/05/2018
ms.openlocfilehash: b2671446594377833609032e27ff02b7c53c763c
ms.sourcegitcommit: 245a4054a52e54d5989d6148fbbe386e1b2aa49c
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/13/2019
ms.locfileid: "70974694"
---
# <a name="recover-from-catastrophic-data-loss"></a>在发生灾难性数据丢失后进行恢复

*适用于：Azure Stack 集成系统。*

Azure Stack 在数据中心运行 Azure 服务，并且可以在安装在单个机架中的四个节点小的环境中运行。 同时，Azure 也可以在 40 多个地区中的多个数据中心内运行，并且每个地区中可以有多个区域。 用户资源可以跨多个服务器、机架、数据中心和地区。 使用 Azure Stack，当前只能选择将整个云部署到单个机架中。 此限制使你的云面临你的数据中心发生灾难性事件的风险，或因主要产品错误而失败。 当灾难发生时，Azure Stack 实例会进入脱机状态。 可能无法恢复所有数据。

根据数据丢失的根本原因，你可能需要修复单个基础结构服务或还原整个 Azure Stack 实例。 你甚至可能需要还原到同一位置或其他位置中的其他硬件。

此方案用于在出现故障和重新部署私有云时恢复整个安装。

| 应用场景                                                           | 数据丢失                            | 注意事项                                                             |
|--------------------------------------------------------------------|--------------------------------------|----------------------------------------------------------------------------|
| 由于灾难或产品 bug，从灾难性数据丢失中恢复。 | 所有基础结构、用户和应用程序数据。 | 用户应用和数据独立于基础结构数据进行保护。 |

## <a name="workflows"></a>Workflows

保护 Azure Stack 的过程从分别备份基础结构和应用/租户数据开始。 本文档介绍了如何保护基础结构。 

![Azure Stack 数据恢复工作流—部署](media/azure-stack-backup/azure-stack-backup-workflow1.png)

在所有数据均丢失的最差情形方案中，恢复 Azure Stack 是还原与 Azure Stack 部署相关的基础结构数据和所有用户数据的过程。 

![Azure Stack 数据恢复工作流-重新部署](media/azure-stack-backup/azure-stack-backup-workflow2.png)

## <a name="restore"></a>还原

如果发生灾难性数据丢失但硬件仍可用，则需要重新部署 Azure Stack。 在重新部署期间，可以指定存储位置和访问备份所需的凭据。 在此模式下，无需指定需要恢复的服务。 基础结构备份控制器将控制层状态插入为部署工作流的一部分。

如果出现导致硬件不可用的灾难，则只能在新硬件上重新部署。 因为要订购更换硬件并等待硬件到达数据中心，所以重新部署可能会花费数周时间。 可以在任何时间还原控制层数据。 但是，如果重新部署的实例的版本超过了在上次备份中使用的版本，则不支持 restore。

| 部署模式 | 起点 | 终点                                                                                                                                                                                                     |
|-----------------|----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 全新安装   | 基线版本 | OEM 部署 Azure Stack，并更新到最新的受支持版本。                                                                                                                                          |
| 恢复模式   | 基线版本 | OEM 在恢复模式下部署 Azure Stack 并根据可用的最新备份来处理版本匹配要求。 OEM 通过更新到最新的受支持版本来完成部署。 |

## <a name="data-in-backups"></a>备份中的数据

Azure Stack 支持称为云恢复模式的部署类型。 只有当灾难或产品 bug 导致解决方案不可恢复后，你选择恢复 Azure Stack 时才使用此模式。 此部署模式不会恢复解决方案中存储的任何用户数据。 此部署模式的作用域仅限于还原以下数据：

 - 部署输入
 - 内部标识服务数据（ADFS 部署）。
 - 联合识别配置（ADFS 部署）。
 - 内部证书颁发机构使用的根证书。
 - Azure 资源管理器配置用户数据，如订阅、计划、产品/服务、存储配额、网络配额和计算资源。
 - Key Vault 的机密和保管库。
 - RBAC 策略分配和角色分配 =。

在部署期间不会恢复任何用户基础结构即服务 (IaaS) 或平台即服务 (PaaS) 资源。 这些损失包括 IaaS Vm、存储帐户、blob、表、网络配置等。 云恢复的目的是确保操作员和用户可以在部署完成后重新登录到门户。 重新登录的用户不会看到其任何资源。 用户会还原他们的订阅，以及管理员定义的原始计划、产品/服务和策略。重新登录到系统的用户在灾难发生之前由原始解决方案施加的相同约束运行。 在云恢复完成后，操作员可以手动还原增值 RP 和第三方 RP 以及关联的数据。

## <a name="next-steps"></a>后续步骤

了解[使用基础结构备份服务](azure-stack-backup-best-practices.md)的最佳做法。
