---
title: 保护在 Azure Stack Hub 上部署的 VM
description: 了解如何生成恢复计划来保护 Azure Stack Hub 上部署的 VM，以防出现数据丢失和计划外停机。
author: mattbriggs
ms.topic: conceptual
ms.date: 02/18/2020
ms.author: mabrigg
ms.reviewer: hectorl
ms.lastreviewed: 3/5/2020
ms.openlocfilehash: 913d0eeed1ba2cfce0b062385a4f544919889f43
ms.sourcegitcommit: a630894e5a38666c24e7be350f4691ffce81ab81
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/16/2020
ms.locfileid: "79512603"
---
# <a name="protect-vms-deployed-on-azure-stack-hub"></a>保护在 Azure Stack Hub 上部署的 VM

使用本文作为指南，帮助你为部署在 Azure Stack 集线器上的用户部署的 IaaS 虚拟机（Vm）开发数据保护和灾难恢复策略。

若要防止数据丢失和延长停机时间，请为用户应用程序及其数据实施备份恢复或灾难恢复计划。 每个应用程序都必须作为组织全面的业务连续性和灾难恢复（BC/DR）策略的一部分进行评估。 很好的起点是[Azure Stack 集线器：业务连续性和灾难恢复的注意事项](https://aka.ms/azurestackbcdrconsiderationswp)。

## <a name="considerations-for-protecting-iaas-vms"></a>保护 IaaS Vm 的注意事项

### <a name="roles-and-responsibilities"></a>角色和职责

首先，请确保对保护和恢复环境中的应用程序所有者和操作员的角色和职责有清楚的了解。

用户负责保护 Vm。 操作员负责使 Azure Stack 集线器保持联机和正常运行。 Azure Stack 中心包含一项服务，该服务可从基础结构服务备份内部服务**数据，不包括任何**用户数据，包括用户创建的 vm、具有用户或应用程序数据的存储帐户，或者用户数据库。


| 应用程序所有者/架构师   | Azure Stack 中心操作员  |
|---    |---    |
| <ul><li>利用云设计原则使应用程序体系结构保持一致。</li></br><li>根据需要实现传统应用程序的现代化，为云环境做好准备。</li></br><li>定义应用程序可接受的 RTO 和 RPO。</li></br><li>确定需要保护的应用程序资源和数据存储库。</li></br><li>实现与应用程序体系结构和客户要求最相符的数据和应用程序恢复方法。</li></ul>     | <ul><li>确定组织的业务连续性和灾难恢复目标。</li></br><li>部署足够的 Azure Stack 中心实例，以满足组织的业务连续性/灾难恢复目标。</li></br><li>设计和操作应用程序/数据保护基础结构。</li></br><li>提供对保护服务的托管解决方案或自助访问权限。</li></br><li>与应用程序所有者/架构师合作，了解应用程序设计并推荐保护策略。</li></br><li>启用基础结构备份以实现服务修复和云恢复。</li></ul>    |

## <a name="sourcetarget-combinations"></a>源/目标组合

需要防范数据中心或站点中断的用户可以使用另一个 Azure Stack 集线器或 Azure 来提供高可用性或快速恢复。 使用主位置和辅助位置，用户可以在两个环境中部署主动/主动或主动/被动配置中的应用程序。 对于不太重要的工作负荷，用户可以使用辅助位置中的容量从备份中执行应用程序的按需还原。

可以将一个或多个 Azure Stack 中心云部署到数据中心。 为了经受灾难性的灾难，在不同的数据中心部署至少一个 Azure Stack 中心云可确保你可以故障转移工作负荷并最大程度地减少计划外停机。 如果只有一个 Azure Stack 集线器，则应考虑使用 Azure 公有云作为恢复云。 确定应用程序的运行位置将由政府法规、公司政策和严格的延迟要求确定。 您可以灵活地确定每个应用程序的适当恢复位置。 例如，可以将一个订阅中的应用程序备份到另一个数据中心，并将数据复制到 Azure 公有云。

## <a name="application-recovery-objectives"></a>应用程序恢复目标

应用程序所有者主要负责确定应用程序和组织可以容忍的停机时间和数据丢失量。 通过量化可接受的停机时间和可接受的数据丢失，你可以创建一个恢复计划，以最大程度地减少组织中发生灾难的影响。 对于每个应用程序，请考虑以下各项：

 - **恢复时间目标（RTO）**  
RTO 是指发生某个事件后，可接受应用不可用的最长时间。 例如，如果 RTO 是 90 分钟，则意味着从发生灾难开始，必须能够在 90 分钟内将应用还原到正常运行状态。 如果 RTO 低，可以持续运转一个后备部署，以防范区域性服务中断。
 - **恢复点目标（RPO）**  
RPO 是指发生灾难期间，可接受数据丢失的最大持续时间。 例如，如果在单个数据库中存储数据并且未将数据复制到其他数据库，而是执行每小时备份，则最长可能会丢失一小时的数据。

另一个指标是*平均恢复时间* (MTTR)，指的是发生故障后还原应用程序所需的平均时间。 MTTR 反映的是系统的经验值。 如果 MTTR 超过 RTO，则系统中的故障会导致无法接受的业务中断，因为无法在定义的 RTO 内还原系统。

## <a name="protection-options"></a>保护选项 

### <a name="backup-restore"></a>备份-还原

通过备份您的应用程序和数据集，可以在数据损坏、意外删除或灾难发生时，从停机时间快速恢复。 对于基于 IaaS VM 的应用程序，你可以使用来宾内代理来保护应用程序数据、操作系统配置以及存储在卷上的数据。 

#### <a name="backup-using-in-guest-agent"></a>使用来宾内代理进行备份

使用来宾操作系统代理备份 VM 通常包括捕获操作系统配置、文件/文件夹、磁盘、应用程序二进制文件或应用程序数据。 

从代理恢复应用程序需要手动重新创建 VM、安装操作系统，以及安装来宾代理。 此时，可以将数据还原到来宾操作系统或直接还原到应用程序。

#### <a name="backup-using-disk-snapshot-for-stopped-vms"></a>使用磁盘快照备份已停止的 Vm

备份产品可以保护连接到已停止 VM 的 IaaS VM 配置和磁盘。 与 Azure Stack 中心 Api 集成的备份产品，用于捕获 VM 配置和创建磁盘快照。 如果可以对应用程序进行计划停机，则在启动备份工作流之前，请确保 VM 处于停止状态。  

#### <a name="backup-using-disk-snapshot-snapshot-for-running-vms"></a>使用磁盘快照快照进行备份以运行 Vm

> [!Important]  
> 虚拟机当前不支持使用磁盘快照处于运行状态。 创建附加到正在运行的 VM 的磁盘的快照可能会降低性能，或者会影响 VM 中的操作系统或应用程序的可用性。 建议使用来宾内代理来保护应用程序（如果不能选择计划停机时间）。 

### <a name="vms-in-a-scale-set-or-availability-group"></a>规模集或可用性组中的 Vm

规模集或可用性组中被视为暂时资源的 Vm 不应在 VM 级别备份，尤其是当应用程序是无状态的情况下。 对于在规模集或可用性组中部署的有状态应用程序，请考虑保护应用程序数据（例如，存储池中的数据库或卷）。 

### <a name="replicationmanual-failover"></a>复制/手动故障转移

对于需要最少的数据丢失或最短停机时间的应用程序，可以在来宾 OS 或应用程序级别启用数据复制，以便将数据复制到其他位置。 某些应用程序（如 Microsoft SQL Server）以本机方式支持复制。 如果该应用程序不支持复制，则可以使用来宾操作系统中的软件来复制磁盘，或者使用作为来宾 OS 中的代理安装的合作伙伴解决方案。

利用此方法，应用程序将部署在一个云中，并将数据复制到本地或 Azure 中的其他云。 触发故障转移时，目标中的应用程序将需要启动并附加到复制的数据，然后才能开始处理请求。
 
### <a name="high-availabilityautomatic-failover"></a>高可用性/自动故障转移

对于只能承受几秒钟或几分钟停机的无状态应用程序，请考虑使用高可用性配置。 高可用性应用程序设计为部署在主动/主动拓扑中的多个位置，所有实例都可以为请求提供服务。 对于本地硬件故障，Azure Stack 集线器基础结构使用2个顶部机箱交换机实现物理网络中的高可用性。 对于计算级别错误，Azure Stack 集线器在一个缩放单位中使用多个节点。 在 VM 级别，可以将规模集与容错域结合使用，以确保节点故障不会关闭应用程序。 需要将同一应用程序部署到相同配置中的辅助位置。 若要使应用程序处于活动/活动状态，可以使用负载均衡器或 DNS 将请求定向到所有可用实例。

### <a name="no-recovery"></a>不恢复

环境中的某些应用可能不需要针对计划外停机或数据丢失进行保护。 例如，用于开发和测试的 VM 通常不需要进行恢复。 您决定在不保护应用程序或数据集的情况下执行此操作。

## <a name="recommended-topologies"></a>建议的拓扑

Azure Stack 中心部署的重要注意事项：

|     | 建议 | 说明 |
|-------------------------------------------------------------------------------------------------|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 将 VM 备份/还原到已部署在数据中心的外部备份目标 | 建议 | 利用现有的备份基础结构和操作技能。 确保在设置备份基础结构的大小时，能够让它保护其他的 VM 实例。 确保备份基础结构不要紧靠源。 可以将 Vm 还原到源 Azure Stack 中心、辅助 Azure Stack 中心实例或 Azure。 |
| 将 Vm 备份/还原到专用于 Azure Stack 集线器的外部备份目标 | 建议 | 你可以为 Azure Stack 中心购买新的备份基础结构或预配专用的备份基础结构。 确保备份基础结构不要紧靠源。 可以将 Vm 还原到源 Azure Stack 中心、辅助 Azure Stack 中心实例或 Azure。 |
| 将 VM 直接备份/还原到全球版 Azure 或受信任的服务提供商 | 建议 | 只要能够满足数据隐私和法规要求，就可以将备份存储到全球版 Azure 或受信任的服务提供商。 理想情况下，服务提供商也会 Azure Stack 集线器上运行，以便在还原时获得操作体验的一致性。 |
| 将 Vm 复制/故障转移到单独的 Azure Stack 集线器实例 | 建议 | 在故障转移情况下，你需要让第二个 Azure Stack 中心云完全操作，因此可以避免应用程序停机时间延长。 |
| 将 VM 直接复制/故障转移到 Azure 或受信任的服务提供商 | 建议 | 只要能够满足数据隐私和法规要求，就可以将数据复制到全球版 Azure 或受信任的服务提供商。 理想情况下，服务提供商也会 Azure Stack 集线器上运行，以便在故障转移后获得操作体验的一致性。 |
| 将备份目标部署到同时承载同一备份目标所保护的所有应用程序的同一 Azure Stack 中心上。 | 独立目标：不推荐 </br> 外部复制备份数据的目标：建议 | 如果选择在 Azure Stack 集线器上部署备份设备（以便优化操作还原），必须确保所有数据都已持续复制到外部备份位置。 |
| 将物理备份设备部署到安装了 Azure Stack 集线器解决方案的同一机架中 | 不支持 | 目前，不能将任何其他设备连接到不属于原始解决方案的架顶式交换机。 |

## <a name="next-steps"></a>后续步骤

本文提供了有关保护 Azure Stack 集线器上部署的用户 Vm 的一般准则。 有关使用 Azure 服务保护用户 VM 的信息，请参阅：

- [Azure Stack IaaS –第四部分–保护你的内容](https://azure.microsoft.com/blog/azure-stack-iaas-part-four/)
- [业务连续性和灾难恢复的注意事项](https://aka.ms/azurestackbcdrconsiderationswp)

### <a name="azure-backup-server"></a>Azure 备份服务器
 - [使用 Azure 备份在 Azure Stack 集线器上备份文件和应用](https://docs.microsoft.com/azure/backup/backup-mabs-files-applications-azure-stack)
 - [Azure Stack 中心 Azure 备份服务器支持](https://docs.microsoft.com/azure/backup/ ) 
 
 ### <a name="azure-site-recovery"></a>Azure Site Recovery
 - [Azure Stack 中心 Azure Site Recovery 支持](https://docs.microsoft.com/azure/site-recovery/)  
 
 ### <a name="partner-products"></a>合作伙伴产品
 - [Azure Stack 中心数据中心集成合作伙伴生态系统数据表](https://aka.ms/azurestackbcdrpartners)
