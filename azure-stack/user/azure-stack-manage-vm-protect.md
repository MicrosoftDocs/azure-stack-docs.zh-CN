---
title: 保护在 Azure Stack 上部署的 VM | Microsoft Docs
description: 了解如何构建恢复计划以防止数据丢失和计划外停机时间在 Azure Stack 上部署的 Vm 进行保护。
services: azure-stack
documentationcenter: ''
author: mattbriggs
manager: femila
editor: ''
ms.assetid: 4e5833cf-4790-4146-82d6-737975fb06ba
ms.service: azure-stack
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: conceptual
ms.date: 05/06/2019
ms.author: mabrigg
ms.reviewer: hectorl
ms.lastreviewed: 3/19/2018
ms.openlocfilehash: 9f8fe959ca200b7000df65b6826a103535aac92a
ms.sourcegitcommit: eccbd0098ef652919f357ef6dba62b68abde1090
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/01/2019
ms.locfileid: "67492405"
---
# <a name="protect-vms-deployed-on-azure-stack"></a>保护在 Azure Stack 上部署的 Vm

使用本文作为指南来制定计划，用以保护用户在 Azure Stack 上部署的虚拟机 (VM)。


若要防止数据丢失和计划外停机时间，您需要实现用户应用程序和其数据的备份恢复或灾难恢复计划。 此计划可能是为每个应用唯一的但遵循一个框架，由你组织的全面的业务连续性和灾难恢复 (BC/DR) 策略。 很好的起点是[Azure Stack:有关业务连续性和灾难恢复注意事项](https://aka.ms/azurestackbcdrconsiderationswp)。

## <a name="azure-stack-infrastructure-recovery"></a>Azure Stack 基础结构恢复

用户负责独立于 Azure Stack 的基础结构服务保护其 VM。

Azure Stack 基础结构服务的恢复计划**不**包括恢复用户 VM、存储帐户或数据库。 作为应用程序所有者，您负责实现针对你的应用和数据的恢复计划。

如果 Azure Stack 云较长时间处于脱机状态或者永久性不可恢复，则需要实施一个具有以下用途的恢复计划：

* 可确保最短停机时间。
* 保留关键 Vm，如运行的数据库服务器。
* 支持使用应用程序保持为用户请求提供服务。

Azure Stack 云的操作员负责创建针对底层 Azure Stack 基础结构和服务的恢复计划。 若要了解详细信息，请参阅[从灾难性数据丢失中恢复](../operator/azure-stack-backup-recover-data.md)。

## <a name="considerations-for-iaas-vms"></a>有关 IaaS VM 的注意事项
在 IaaS VM 中安装的操作系统限制它包含可用于保护的数据的产品。 对于 Windows 基于 IaaS Vm，可以使用 Microsoft 和合作伙伴产品来保护数据。 对于基于 Linux 的 IaaS VM，唯一的选择是使用合作伙伴产品。 请参阅[此数据表，了解其产品适用于 Azure Stack 的所有 BC/DR 合作伙伴](https://aka.ms/azurestackbcdrpartners)。

## <a name="sourcetarget-combinations"></a>源/目标组合

每个 Azure Stack 云都部署到一个数据中心。 一个单独的环境需要来恢复您的应用程序。 该恢复环境可以是另一数据中心内的另一个 Azure Stack 云，也可以是 Azure 公有云。 数据自主性和数据的隐私要求确定您的应用程序的恢复环境。 当启用对每个应用的保护，可以灵活地选择为每个特定的恢复选项。 您可以应用数据备份到另一个数据中心的一个订阅中。 在另一订阅中，可以将数据复制到 Azure 公有云。

计划为每个应用，以确定针对每个应用的备份恢复和灾难恢复策略。 恢复计划可帮助您正确大小存储所需容量的本地和公有云中的消耗进行计划的组织。

|  | 全球 Azure | 部署到 CSP 数据中心并由 CSP 操作的 Azure Stack | 部署到客户数据中心并由客户操作的 Azure Stack |
|------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------|
| **部署到 CSP 数据中心并由 CSP 操作的 Azure Stack** | 用户 Vm 部署到 CSP 运营 Azure Stack。<br><br>用户 VM 从备份还原，或者直接故障转移到 Azure。 | CSP 在自己的数据中心操作 Azure Stack 的主要和次要实例。<br><br>用户 VM 在这两个 Azure Stack 实例之间还原或故障转移。 | CSP 在主要站点操作 Azure Stack。<br><br>客户的数据中心是还原或故障转移目标。 |
| **部署到客户数据中心并由客户操作的 Azure Stack** | 用户 Vm 部署到客户运营 Azure Stack。<br><br>用户 VM 从备份还原，或者直接故障转移到 Azure。 | 客户在主要站点操作 Azure Stack。<br><br>CSP 的数据中心是还原或故障转移目标。 | 客户在自己的数据中心操作 Azure Stack 的主要和次要实例。<br><br>用户 VM 在这两个 Azure Stack 实例之间还原或故障转移。 |

![源-目标组合](media/azure-stack-manage-vm-backup/vm_backupdataflow_01.png)

## <a name="app-recovery-objectives"></a>应用恢复目标

确定你的组织可以容忍的针对每个应用程序的停机时间和数据丢失量。 通过量化停机时间和数据丢失，可以创建可在你的组织在发生灾难的影响降至最低的恢复计划。 对于每个应用，请考虑：

 - **恢复时间目标 (RTO)**  
RTO 是某个事件后，应用可以是不可用的最长可接受时间。 例如，90 分钟的 RTO 意味着您必须能够从灾难开始应用到正在运行的状态还原在 90 分钟内。 如果 RTO 低，可以持续运转一个后备部署，以防范区域性服务中断。
 - **恢复点目标 (RPO)**  
RPO 是指发生灾难期间，可接受数据丢失的最大持续时间。 例如，如果将数据存储在单个数据库中每小时备份，且不要复制到其他数据库，则可能会丢失长达一小时的数据。

RTO 和 RPO 属于业务要求。 应用程序执行风险评估来定义应用程序的 RTO 和 RPO。

另一个指标是**平均恢复时间**(MTTR)，这是在发生故障后还原应用程序所需的平均时间。 MTTR 反映的是系统的经验值。 如果 MTTR 超过 RTO，系统中的失败将导致不可接受的业务中断，因为它无法在定义的 RTO 内将系统还原。

### <a name="backup-restore"></a>备份-还原

基于 VM 的应用程序的最常见保护方案是使用备份软件。 备份 VM 通常包括操作系统、 操作系统配置、 应用程序二进制文件和应用数据。 可以通过拍摄卷、磁盘或整个 VM 的快照来创建备份。 使用 Azure Stack 时，可以灵活地选择是从来宾 OS 的上下文中备份，还是从 Azure Stack 存储和计算 API 备份。 Azure Stack 不支持在虚拟机监控程序级别进行备份。
 
![备份-还原](media/azure-stack-manage-vm-backup/vm_backupdataflow_03.png)

恢复应用程序需要一个或多个 Vm 还原到相同的云或新的云。 可以将数据中心的云或公有云作为目标。 选择的云完全由你来控制，并且取决于数据隐私和自主性要求。

 - RTO：以小时计量的停机时间
 - RPO：可变数据丢失（取决于备份频率）
 - 部署拓扑：主动/被动

#### <a name="planning-your-backup-strategy"></a>规划备份策略

在计划备份策略和定义缩放要求时，首先应确定需要保护的 VM 实例的数目。 一个常见的策略是备份环境中所有服务器的所有 VM。 但在使用 Azure Stack 时，某些 VM 不需备份。 例如，可以将规模集中的 VM 视为暂时性资源，这些资源时来时去，有时甚至不会有通知，这些 VM 就不需要备份。 任何需要保护的持久数据都存储在单独的存储库（例如数据库或对象存储）中。

在 Azure Stack 上备份 VM 的重要注意事项：

 - **分类**
    - 考虑一个用户参与 VM 备份的模型。
    - 定义的恢复服务级别协议 (SLA 基于优先级的应用程序或对业务的影响)。
 - **缩放**
    - 在载入大量新的 VM 时考虑进行交错式备份（如果必须备份）。
    - 评估可以有效地捕获和传输备份数据的备份产品，尽量减少解决方案上的资源内容。
    - 评估可以通过增量备份或差异备份有效存储备份数据的备份产品，尽量减少为环境中的所有 VM 创建完整备份的需求。
 - **Restore**
    - 备份产品可以还原现有 VM，或整个 VM 资源中的应用程序数据的虚拟磁盘和关联的虚拟磁盘。 所需的还原方案取决于您计划如何还原应用程序。 例如，从模板重新部署 SQL Server 并还原数据库而不是还原整个 VM 或 VM 集可能会更容易。

### <a name="replicationmanual-failover"></a>复制/手动故障转移

支持高可用性的替代方法是将您的应用程序 Vm 复制到另一个云并依赖于手动故障转移。 可以在 VM 级别或来宾 OS 级别执行的操作系统、 应用程序二进制文件和应用程序数据复制。 使用不是应用程序的一部分的其他软件管理故障转移。

使用此方法时，在一个云中部署应用和其 VM 复制到其他云。 如果触发了故障转移，则需在第二个云中启动辅助 VM。 在某些情况下，故障转移会创建 VM 并向其附加磁盘。 此过程可能需要很长时间才能完成，特别是在多层应用程序，需要具有特定启动顺序。 此外可能必须运行才能应用已准备好开始处理请求的步骤。

![复制-手动故障转移](media/azure-stack-manage-vm-backup/vm_backupdataflow_02.png)

 - RTO：以分钟计量的停机时间
 - RPO：可变数据丢失（取决于复制频率）
 - 部署拓扑：主动/被动备用
 
### <a name="high-availabilityautomatic-failover"></a>高可用性/自动故障转移

可以仅允许你的业务应用的几秒或分钟的停机时间和最小的数据丢失，请考虑高可用性配置。 高可用性应用程序旨在快速自动地从故障中恢复。 对于本地硬件故障，Azure Stack 基础结构使用两个架顶式交换机在物理网络中实现高可用性。 对于计算级别故障，Azure Stack 在一个缩放单元中使用多个节点。 在 VM 级别，可用于组合中的规模集与容错域确保节点故障垮你的应用。

使用规模集的组合，在您的应用程序将需要以本机方式支持高可用性或支持使用群集软件。 例如，对于使用同步提交模式的数据库，Microsoft SQL Server 提供本机高可用性支持。 但是，如果只能支持异步复制，则会存在某种程度的数据丢失。 此外可以将应用部署到其中的群集软件处理应用程序的自动故障转移的故障转移群集中。

使用此方法，该应用程序仅处于活动状态在一个云中，但软件部署到多个云。 其他云处于备用模式即可触发故障转移时启动该应用程序。

 - RTO：以秒衡量的停机时间
 - RPO：最少数据丢失量
 - 部署拓扑：主动/主动备用

### <a name="fault-tolerance"></a>容错

Azure Stack 物理冗余和基础结构服务可用性只能针对硬件级别错误/故障如磁盘、 电源、 网络端口或节点保护。 但是，如果您的应用程序必须始终可用且永远不会丢失任何数据，你需要应用程序中实施本机容错，或使用其他软件启用容错能力。

首先，需要确保应用程序部署 Vm 时使用的小数位数设置以针对节点级故障提供保护。 为了应对云脱机，同一应用程序必须已部署到另一个云以便它可以继续处理请求，而不发生中断。 此模型通常称为主动-主动部署。

请记住，每个 Azure Stack 云是互相独立的，因此从基础结构角度来看，始终可以将这些云视为处于活动状态。 在这种情况下，多个活动实例的应用程序部署到一个或多个活动的云。

 - RTO：无停机
 - RPO：无数据丢失
 - 部署拓扑：主动/主动

### <a name="no-recovery"></a>不恢复

你的环境中的某些应用可能不需要对非计划停机时间或数据丢失防护。 例如，虚拟机用于开发和测试通常不需要进行恢复。 它由你自行决定不受保护的应用或特定的 VM 执行操作。 Azure Stack 不会从底层基础结构提供 Vm 的备份或复制。 与 Azure 一样，您需要选择中加入对每个订阅的每个 VM 的保护。

 - RTO：无法恢复
 - RPO：完全数据丢失

## <a name="recommended-topologies"></a>建议的拓扑

Azure Stack 部署的重要注意事项：

|     | 建议 | 注释 |
|-------------------------------------------------------------------------------------------------|-----------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 将 VM 备份/还原到已部署在数据中心的外部备份目标 | 建议 | 利用现有的备份基础结构和操作技能。 请确保调整大小的备份基础结构，使它已准备好保护其他的 VM 实例。 请确保备份基础结构不在紧靠您的源。 可以将 VM 还原到源 Azure Stack、辅助 Azure Stack 实例或 Azure。 |
| 将 VM 备份/还原到专用于 Azure Stack 的外部备份目标 | 建议 | 可以为 Azure Stack 购买新的备份基础结构或预配专用的备份基础结构。 请确保备份基础结构不在紧靠您的源。 可以将 VM 还原到源 Azure Stack、辅助 Azure Stack 实例或 Azure。 |
| 将 VM 直接备份/还原到全球版 Azure 或受信任的服务提供商 | 建议 | 只要能够满足数据隐私和法规要求，就可以将备份存储到全球版 Azure 或受信任的服务提供商。 理想情况下，该服务提供商也会运行 Azure Stack，因此你在还原时获得的操作体验是一致的。 |
| 将 VM 复制/故障转移到单独的 Azure Stack 实例 | 建议 | 在故障转移情况下，需要具有完全正常运行的第二个 Azure Stack 云，因此可以避免扩展应用程序停机时间。 |
| 将 VM 直接复制/故障转移到 Azure 或受信任的服务提供商 | 建议 | 只要能够满足数据隐私和法规要求，就可以将数据复制到全球版 Azure 或受信任的服务提供商。 理想情况下，该服务提供商也会运行 Azure Stack，因此你在故障转移后获得的操作体验是一致的。 |
| 将与你的应用程序数据的同一 Azure Stack 云上的备份目标部署 | 不建议 | 避免将备份存储在相同的 Azure Stack 云中。 云出现计划外停机可能会导致你无法接触主数据和备份数据。 如果选择将备份目标部署为虚拟设备（目的是针对备份和还原进行优化），则必须确保将所有数据持续复制到外部备份位置。 |
| 将物理备份设备部署到安装了 Azure Stack 解决方案的机架 | 不支持 | 目前，不能将任何其他设备连接到不属于原始解决方案的架顶式交换机的顶部。 |

## <a name="next-steps"></a>后续步骤

本文提供了用于保护 Azure Stack 上部署的用户 VM 的一般准则。 有关使用 Azure 服务保护用户 VM 的信息，请参阅：

 - [使用 Azure 备份来备份 Azure Stack 上的文件和应用程序](https://docs.microsoft.com/azure/backup/backup-mabs-files-applications-azure-stack)
 - [针对 Azure Stack 的 Azure 备份服务器支持](https://docs.microsoft.com/azure/backup/ ) 
 - [针对 Azure Stack 的 Azure Site Recovery 支持](https://docs.microsoft.com/azure/site-recovery/)  

若要了解有关 Azure Stack 提供 VM 保护的合作伙伴产品的详细信息，请参阅[保护应用和 Azure Stack 上的数据](https://azure.microsoft.com/blog/protecting-applications-and-data-on-azure-stack/)。
