---
title: 了解 Azure Stack HCI 上的群集和池仲裁
description: 了解 Azure Stack HCI 存储空间直通上的群集和池仲裁，其中包含用于处理复杂情况的特定示例。
author: khdownie
ms.author: v-kedow
ms.topic: article
ms.date: 02/28/2020
ms.openlocfilehash: 70f10bd8c2c2e5eb639229ba743090ba5e5ac79c
ms.sourcegitcommit: a77dea675af6500bdad529106f5782d86bec6a34
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/10/2020
ms.locfileid: "79025674"
---
# <a name="understanding-cluster-and-pool-quorum-on-azure-stack-hci"></a>了解 Azure Stack HCI 上的群集和池仲裁

>适用于： Windows Server 2019

[Windows Server 故障转移群集](/windows-server/failover-clustering/failover-clustering-overview)为工作负荷提供高可用性。 如果承载资源的节点已启动，这些资源将被视为高可用资源;但是，群集通常需要一半以上的节点运行，这称为 "有*仲裁*"。

仲裁旨在防止在网络中存在分区时可能会发生的*分裂大脑*方案，并且节点的子集无法相互通信。 这可能导致两个节点子集都尝试拥有工作负荷并写入同一磁盘，这可能会导致许多问题。 但是，这会阻止故障转移群集的仲裁概念，这只强制其中一组节点继续运行，因此，只有其中一个组将保持联机状态。

仲裁确定群集在仍处于联机状态时可以承受的故障数。 仲裁设计用于处理在群集节点的子集之间存在通信问题时，多个服务器不会尝试同时托管资源组和将资源写入同一磁盘的情况。 通过具有仲裁的这一概念，群集将强制群集服务在其中一个节点子集停止，以确保只有一个特定资源组的真正所有者。 一旦已停止的节点再次与节点的主组通信，它们将自动重新加入群集并启动其群集服务。

在 Windows Server 2019 中，有两个具有自己的仲裁机制的系统组件：

- **群集仲裁**：此操作在群集级别进行（即，可以丢失节点并使群集保持正常运行）
- **池仲裁**：当启用存储空间直通（即，可以丢失节点和驱动器，并使池保持运行状态）时，将在池级别上操作。 存储池设计用于群集和非群集方案，这就是它们具有不同仲裁机制的原因。

## <a name="cluster-quorum-overview"></a>群集仲裁概述

下表提供了每个方案的群集仲裁结果的概述：

| 服务器节点 | 可经受一个服务器节点故障 | 可以经受一个服务器节点故障，另一个 | 可经受两个同时发生的服务器节点故障 |
|--------------|-------------------------------------|---------------------------------------------------|----------------------------------------------------|
| 2            | 50/50                               | 是                                                | 是                                                 |
| 2 + 见证服务器  | 是                                 | 是                                                | 是                                                 |
| 3            | 是                                 | 50/50                                             | 是                                                 |
| 3 + 见证服务器  | 是                                 | 是                                               | 是                                                 |
| 4            | 是                                 | 是                                               | 50/50                                              |
| 4 + 见证服务器  | 是                                 | 是                                               | 是                                                |
| 5及更高版本  | 是                                 | 是                                               | 是                                                |

### <a name="cluster-quorum-recommendations"></a>群集仲裁建议

- 如果有两个节点，则**需要**见证服务器。
- 如果有三个或四个节点，则**强烈建议使用**见证服务器。
- 如果可以访问 Internet，请使用 **[云见证](/windows-server/failover-clustering/deploy-cloud-witness)**
- 如果你在使用其他计算机和文件共享的 IT 环境中，请使用文件共享见证

## <a name="how-cluster-quorum-works"></a>群集仲裁的工作原理

当节点出现故障时，或者当某个部分的节点与另一个子集失去联系时，仍然存在的节点需要验证它们*构成了哪些*群集仍处于联机状态。 如果他们无法验证，它们将处于脱机状态。

但*大多数*情况下，仅当群集中的节点总数为奇数（例如，五个节点的群集中的三个节点）时，才会完全可用。 那么，具有偶数个节点的群集（假设有四个节点的群集）呢？

群集可通过两种方式将*投票总数*设置为奇数：

1. 首先，通过添加具有额外投票的*见证*服务器来执行*此项。* 这需要用户设置。
2. 或者，它可以*向下移动*一个不幸节点的投票（根据需要自动执行）。

一旦工作节点成功验证它们是*多数*，就会将*多数*定义更新为仅 survivors。 这允许群集失去一个节点，然后再丢失另一个节点，等等。 连续失败后的*投票总数*的这一概念称为 "***动态仲裁***"。  

### <a name="dynamic-witness"></a>动态见证

动态见证服务器会切换见证服务器的投票，以确保*投票的总数*是奇数。 如果投票数为奇数，则见证服务器不会产生投票。 如果投票数为偶数，则见证服务器有投票。 动态见证极大地降低了因见证服务器故障而导致群集出现故障的风险。 群集根据群集中可用的投票节点数量决定是否使用见证服务器投票。

动态仲裁的工作方式如下所述。

### <a name="dynamic-quorum-behavior"></a>动态仲裁行为

- 如果有**偶数**个节点而没有见证服务器，则*一个节点会将其投票*设置为零。 例如，只有这四个节点中的三个获得了投票，因此*投票总数*为三个，而两个投票的 survivors 被视为一个多数节点。
- 如果有**奇数**个节点而没有见证服务器，*它们会获得投票*。
- 如果有**偶数**个节点和见证服务器，*则见证服务器投票*，因此总计是奇数。
- 如果节点数为**奇数**，则*见证服务器不会投票*。

动态仲裁允许动态地将投票分配给节点，以避免丢失大多数投票，并允许群集使用一个节点（称为最后一位）运行。 让我们以一个四节点的群集为例。 假定仲裁需要3个投票。 

在这种情况下，如果丢失两个节点，则群集将会关闭。

![显示四个群集节点的关系图，其中每个节点都可获取投票](media/quorum/dynamic-quorum-base.png)

但是，动态仲裁会阻止此情况发生。 仲裁所需的*总投票数*现在根据可用节点数来确定。 因此，即使丢失三个节点，群集也会保持不变。

![显示四个群集节点的关系图，其中每次有一个节点发生故障，以及在每次失败后所需的投票数调整。](media/quorum/dynamic-quorum-step-through.png)

上述方案适用于未启用存储空间直通的常规群集。 但是，当启用存储空间直通时，群集只能支持两个节点故障。 "[池仲裁" 部分](#pool-quorum-overview)中对此进行了详细介绍。

### <a name="examples"></a>示例

#### <a name="two-nodes-without-a-witness"></a>没有见证服务器的两个节点。
一个节点的投票数为零，因此，*大多数*投票均由**1 个投票**决定。 如果非投票节点意外关闭，则存活具有1/1 和群集置。 如果投票节点意外关闭，则存活的状态为0/1，群集将会关闭。 如果投票节点正常关闭，则会将投票转移到另一个节点，并将分类置。 ***这就是为什么要配置见证服务器非常重要的原因。***

![如果两个节点没有见证服务器，则为仲裁所述](media/quorum/2-node-no-witness.png)

- 可经受一次服务器故障： **50%** 。
- 可能会在一台服务器出现故障后仍然存在，另一种：**否**。
- 一次可能会经受两个服务器故障：**否**。

#### <a name="two-nodes-with-a-witness"></a>具有见证服务器的两个节点。
这两个节点还投票，以及见证服务器投票，因此，*大多数*投票都是由**3 个投票**决定的。 如果其中一个节点出现故障，存活将具有2/3，并且置群集。

![具有见证服务器的两个节点的情况下的仲裁](media/quorum/2-node-witness.png)

- 可经受一个服务器故障：**是**。
- 可能会在一台服务器出现故障后仍然存在，另一种：**否**。
- 一次可能会经受两个服务器故障：**否**。

#### <a name="three-nodes-without-a-witness"></a>无见证服务器的三个节点。
所有节点都要投票，因此，*大多数***投票**均被确定。 如果有任何节点出现故障，survivors 为2/3，群集置。 群集成为两个没有见证服务器的节点–此时，你处于方案1中。

![在没有见证服务器的情况下，在有三个节点的情况下进行仲裁解释](media/quorum/3-node-no-witness.png)

- 可经受一个服务器故障：**是**。
- 可能会在一台服务器出现故障后仍然存在，另一种可能是**50%** 。
- 一次可能会经受两个服务器故障：**否**。

#### <a name="three-nodes-with-a-witness"></a>具有见证服务器的三个节点。
所有节点都要投票，因此见证服务器最初不会投票。 *大多数*都是由**3 个投票**组成的。 发生一次故障后，群集将有两个具有见证服务器的节点，该节点返回到方案2。 现在，两个节点和见证服务器投票。

![具有见证服务器的三个节点的情况下的仲裁](media/quorum/3-node-witness.png)

- 可经受一个服务器故障：**是**。
- 可能会在一台服务器出现故障后仍然存在，另一种：**是**。
- 一次可能会经受两个服务器故障：**否**。

#### <a name="four-nodes-without-a-witness"></a>不含见证服务器的四个节点
一个节点的投票数为零，因此 *，最多*可确定总共3个**投票**。 发生一次故障后，群集将变为三个节点，并且你在方案3中。

![在没有见证服务器的情况下具有四个节点的情况下的仲裁](media/quorum/4-node-no-witness.png)

- 可经受一个服务器故障：**是**。
- 可能会在一台服务器出现故障后仍然存在，另一种：**是**。
- 一次可经受两次服务器故障： **50% 的几率**。

#### <a name="four-nodes-with-a-witness"></a>具有见证服务器的四个节点。
所有节点都投票和见证服务器投票，因此，*大多数*都是由**5 投票**决定。 发生一次故障后，你将处于方案4中。 两次同时发生故障后，将跳到方案2。

![具有见证服务器的四个节点的情况下的仲裁](media/quorum/4-node-witness.png)

- 可经受一个服务器故障：**是**。
- 可能会在一台服务器出现故障后仍然存在，另一种：**是**。
- 一次可能会经受两个服务器故障：**是**。 

#### <a name="five-nodes-and-beyond"></a>五个节点。
所有节点都要投票，或除一次投票以外的所有点，不管总的是奇数。 存储空间直通无法同时处理两个以上的节点，因此，此时不需要见证服务器，也不会有用。

![如果有五个节点，则为仲裁解释](media/quorum/5-nodes.png)

- 可经受一个服务器故障：**是**。
- 可能会在一台服务器出现故障后仍然存在，另一种：**是**。
- 一次可能会经受两个服务器故障：**是**。 

现在，我们了解了仲裁的工作原理，接下来查看仲裁见证服务器的类型。

### <a name="quorum-witness-types"></a>仲裁见证类型

故障转移群集支持三种类型的仲裁见证服务器：

- **[云见证](/windows-server/failover-clustering/deploy-cloud-witness)** -群集的所有节点可访问的 Azure Blob 存储。 它在见证服务器日志文件中维护群集信息，但不存储群集数据库的副本。
- **文件共享见证**–在运行 Windows server 的文件服务器上配置的 SMB 文件共享。 它在见证服务器日志文件中维护群集信息，但不存储群集数据库的副本。
- **磁盘见证**-群集可用存储组中的小型群集磁盘。 此磁盘高度可用，可以在节点之间进行故障转移。 它包含群集数据库的副本。  ***存储空间直通不支持磁盘见证***。

## <a name="pool-quorum-overview"></a>池仲裁概述

我们刚刚讨论过群集仲裁，它在群集级别运行。 现在，让我们深入了解池仲裁，它在池级别上运行（也就是说，你可以丢失节点和驱动器，并使池保持同步）。 存储池设计用于群集和非群集方案，这就是它们具有不同仲裁机制的原因。

下表提供了每个方案的池仲裁结果的概述：

| 服务器节点 | 可经受一个服务器节点故障 | 可以经受一个服务器节点故障，另一个 | 可经受两个同时发生的服务器节点故障 |
|--------------|-------------------------------------|---------------------------------------------------|----------------------------------------------------|
| 2            | 是                                  | 是                                                | 是                                                 |
| 2 + 见证服务器  | 是                                 | 是                                                | 是                                                 |
| 3            | 是                                 | 是                                                | 是                                                 |
| 3 + 见证服务器  | 是                                 | 是                                                | 是                                                 |
| 4            | 是                                 | 是                                                | 是                                                 |
| 4 + 见证服务器  | 是                                 | 是                                               | 是                                                |
| 5及更高版本  | 是                                 | 是                                               | 是                                                |

## <a name="how-pool-quorum-works"></a>池仲裁的工作原理

当驱动器出现故障时，或者当某个部分驱动器失去与另一个子集的联系时，仍然存在的驱动器需要验证它们是否构成了*大部分*的池以保持联机状态。 如果他们无法验证，它们将处于脱机状态。 池是离线的实体，或基于是否有足够的磁盘用于仲裁的实体（50% + 1）。 池资源所有者（活动群集节点）可以为 + 1。

但池仲裁在以下方面与群集仲裁的工作方式不同：

- 池使用群集中的一个节点作为见证服务器，使半个驱动器仍然存在（此节点是池资源所有者）
- 池没有动态仲裁
- 池未实现其自己的删除投票的版本

### <a name="examples"></a>示例

#### <a name="four-nodes-with-a-symmetrical-layout"></a>具有对称布局的四个节点。 
16个驱动器中的每一个都有一个投票，节点2也有一个投票（因为它是池资源所有者）。 *大多数*都是由**16 个投票**组成的。 如果节点三和四出现故障，则仍存在的子集具有8个驱动器和池资源所有者，即9/16 投票。 因此，池置。

![池仲裁1](media/quorum/pool-1.png)

- 可经受一个服务器故障：**是**。
- 可能会在一台服务器出现故障后仍然存在，另一种：**是**。
- 一次可能会经受两个服务器故障：**是**。 

#### <a name="four-nodes-with-a-symmetrical-layout-and-drive-failure"></a>具有对称布局和驱动器故障的四个节点。 
16个驱动器中的每一个都有一个投票，节点2也有一个投票（因为它是池资源所有者）。 *大多数*都是由**16 个投票**组成的。 首先，驱动器7出现故障。 如果节点三和四出现故障，则仍存在的子集具有7个驱动器和池资源所有者，即8/16 投票。 因此，该池并不会出现任何问题。

![池仲裁2](media/quorum/pool-2.png)

- 可经受一个服务器故障：**是**。
- 可能会在一台服务器出现故障后仍然存在，另一种：**否**。
- 一次可能会经受两个服务器故障：**否**。 

#### <a name="four-nodes-with-a-non-symmetrical-layout"></a>具有非对称布局的四个节点。 
24个驱动器中的每一个都有一个投票，节点2也有一个投票（因为它是池资源所有者）。 *大多数*都由**24 个投票**决定。 如果节点三和四出现故障，则仍存在的子集具有8个驱动器和池资源所有者，即9/24 投票。 因此，该池并不会出现任何问题。

![池仲裁3](media/quorum/pool-3.png)

- 可经受一个服务器故障：**是**。
- 在出现一次服务器故障后，另一种： * * 依赖于 * * （如果两个节点都出现故障，则不能保留，但可以经受所有其他方案。
- 一次可能会经受两个服务器故障： * * 取决于 * * （如果两个节点都出现故障，则无法保留，但仍可经受所有其他方案。

### <a name="pool-quorum-recommendations"></a>池仲裁建议

- 确保群集中的每个节点都对称（每个节点具有相同数量的驱动器）
- 启用三向镜像或双重奇偶校验，以便能够容忍节点故障并使虚拟磁盘保持联机。 
- 如果有两个以上的节点关闭，或者两个节点上的一个磁盘处于关闭状态，则可能无法访问其数据的所有三个副本，因而脱机并不可用。 建议快速将服务器恢复或更换磁盘，以确保卷中所有数据的复原能力最大。

## <a name="next-steps"></a>后续步骤

有关详细信息，请参阅以下内容：

- [配置和管理仲裁](/windows-server/failover-clustering/manage-cluster-quorum)
- [部署云见证](/windows-server/failover-clustering/deploy-cloud-witness)
